<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFC-OS | Sistem Manajemen Bisnis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db;}
        .card { background-color: #1f2937; border: 1px solid #374151; }
        .menu-button { background-color: #374151; color: #e5e7eb; border: 1px solid #4b5563; padding: 0.75rem; border-radius: 0.5rem; text-align: center; transition: all 0.2s ease-in-out; font-weight: 600; }
        .menu-button:hover:not(:disabled) { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .menu-button:disabled { background-color: #374151; color: #6b7280; border-color: #4b5563; cursor: not-allowed; opacity: 0.5; }
        .qty-button { width: 28px; height: 28px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: background-color 0.2s; background-color: #374151; color: #d1d5db; }
        .qty-button:hover { background-color: #4b5563; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 50; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .printable-area { display: none; position: absolute; left: -9999px; background: white; color: black; }
        #receipt-template { width: 302px; padding: 15px; font-family: 'Courier New', Courier, monospace; font-size: 12px; }
        #shift-report-template { width: 794px; padding: 40px; font-family: 'Arial', sans-serif; font-size: 12px; }
        .sidebar-item { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; cursor: pointer; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #374151; color: white; }
        .sidebar-item svg { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; }
        .kds-ticket { background-color: #1f2937; border: 1px solid #4b5563; border-left-width: 4px; }
        .kds-ticket.new { border-left-color: #3b82f6; }
        .kds-ticket.cooking { border-left-color: #f59e0b; }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900">
        <div class="w-full max-w-sm p-8 space-y-6 bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-white">FFC-OS</h1>
                <p class="text-gray-400">Login untuk mengakses sistem</p>
            </div>
            <div class="space-y-4">
                <div><label for="username" class="text-sm font-bold text-gray-400 block">Username</label><input type="text" id="username" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md mt-1 focus:ring-blue-500 focus:border-blue-500 text-white"></div>
                <div><label for="password" class="text-sm font-bold text-gray-400 block">Password</label><input type="password" id="password" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md mt-1 focus:ring-blue-500 focus:border-blue-500 text-white"></div>
            </div>
            <p id="login-error" class="text-sm text-center text-red-400 h-4"></p>
            <button onclick="handleLogin()" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded-md text-white text-lg font-bold transition-colors">Login</button>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="main-app" class="h-screen w-screen flex bg-gray-900 hidden">
        <!-- SIDEBAR -->
        <aside class="w-64 bg-gray-800 p-4 flex flex-col border-r border-gray-700">
            <div class="text-2xl font-bold text-white mb-4">FFC-OS</div>
            <div id="branch-selector-container" class="mb-4 hidden"><label for="branch-selector" class="text-xs text-gray-400">Pilih Cabang</label><select id="branch-selector" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md mt-1 text-sm"></select></div>
            <nav id="sidebar-nav" class="flex-grow space-y-2"></nav>
            <div class="mt-auto">
                <div class="p-3 bg-gray-900 rounded-lg"><div class="text-sm font-semibold text-white" id="user-name-display"></div><div class="text-xs text-gray-400" id="user-role-display"></div></div>
                <button onclick="handleLogout()" class="w-full mt-3 flex items-center justify-center py-2 px-4 bg-red-600 hover:bg-red-700 rounded-md text-white font-semibold transition-colors">Logout</button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main id="main-content" class="flex-1 p-6 overflow-y-auto"></main>
    </div>

    <!-- PAGE TEMPLATES -->
    <template id="dashboard-page">
        <div class="space-y-6"><h1 class="text-3xl font-bold text-white">Dashboard <span id="dashboard-branch-name" class="text-blue-400"></span></h1><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="card p-4"><h3 class="text-gray-400">Pendapatan Hari Ini</h3><p id="kpi-revenue" class="text-3xl font-bold text-white mt-1">Rp 0</p></div><div class="card p-4"><h3 class="text-gray-400">Transaksi Hari Ini</h3><p id="kpi-transactions" class="text-3xl font-bold text-white mt-1">0</p></div><div class="card p-4"><h3 class="text-gray-400">Produk Terjual</h3><p id="kpi-items-sold" class="text-3xl font-bold text-white mt-1">0</p></div></div><div class="card p-4"><h3 class="font-bold text-white mb-4">Penjualan 7 Hari Terakhir</h3><div id="sales-chart" class="h-64 w-full flex items-end gap-2 p-4"></div></div><div class="card p-4"><h3 class="font-bold text-white mb-4">Performa Cabang Hari Ini</h3><div id="branch-performance-table" class="overflow-x-auto"></div></div></div>
    </template>
    <template id="pos-page">
        <main class="grid grid-cols-1 xl:grid-cols-3 gap-6"><section class="xl:col-span-1 flex flex-col gap-6"><div class="card p-4"><h2 class="text-2xl font-bold text-white mb-4">Pilih Menu</h2><div id="menu-container" class="flex flex-col gap-6"></div></div></section><section class="xl:col-span-1 flex flex-col gap-6"><div class="card p-4"><h2 class="text-2xl font-bold text-white mb-4">Transaksi Saat Ini</h2><div class="overflow-y-auto min-h-[200px] max-h-[400px] pr-2"><table class="w-full text-left"><tbody id="cart-table-body" class="divide-y divide-gray-700"></tbody></table></div><div class="border-t-2 border-gray-700 border-dashed mt-4 pt-4"><div class="flex justify-between items-center font-semibold text-md mb-2"><span>Subtotal</span><span id="cart-subtotal">Rp 0</span></div><div id="discount-display" class="flex justify-between items-center font-semibold text-md mb-2 text-red-400 hidden"><span>Diskon</span><span id="cart-discount-amount">- Rp 0</span></div><div class="flex justify-between items-center font-bold text-xl mb-4 border-t border-gray-700 pt-2"><span>Total</span><span id="cart-total">Rp 0</span></div><button onclick="openDiscountModal()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-yellow-900 font-bold py-2 rounded-lg text-md mb-2">Tambah Diskon</button><div class="mb-4"><span class="text-sm font-bold text-gray-300">Metode Pembayaran:</span><div class="flex justify-around mt-2"><label class="flex items-center gap-2"><input type="radio" name="paymentMethod" value="Tunai" checked class="bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500"> Tunai</label><label class="flex items-center gap-2"><input type="radio" name="paymentMethod" value="QRIS" class="bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500"> QRIS</label><label class="flex items-center gap-2"><input type="radio" name="paymentMethod" value="Debit" class="bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500"> Debit</label></div></div><button onclick="saveTransaction()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-lg transition-all duration-300 flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>Simpan Transaksi</button></div></div></section><section class="xl:col-span-1 flex flex-col gap-6"><div class="card p-4"><h2 class="text-2xl font-bold text-white mb-4">Produk Terlaris Hari Ini</h2><div id="best-sellers-container" class="space-y-2"></div></div><div class="card p-4"><h2 class="text-2xl font-bold text-white mb-4">Riwayat Transaksi</h2><div id="transaction-history" class="overflow-y-auto max-h-[400px] pr-2 space-y-2"></div></div></section></main>
    </template>
    <template id="kds-page">
        <div class="space-y-6"><h1 class="text-3xl font-bold text-white">Tampilan Dapur (KDS)</h1><div id="kds-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div></div>
    </template>
    <template id="reports-page">
        <div class="space-y-6"><h1 class="text-3xl font-bold text-white">Laporan</h1><div class="card p-4"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-white">Laporan Harian</h2><div class="flex gap-2"><input type="date" id="report-page-date" class="p-2 border rounded-lg bg-gray-700 border-gray-600 text-white shadow-sm"><button onclick="generateShiftReport()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors flex items-center justify-center gap-2">PDF</button><button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors flex items-center justify-center gap-2">Excel</button></div></div></div></div>
    </template>
    <template id="settings-page">
        <div class="space-y-6"><h1 class="text-3xl font-bold text-white">Pengaturan</h1><div class="card p-4"><h2 class="text-xl font-bold text-white mb-4">Kelola Menu, Harga & Stok</h2><div id="menu-management-list" class="space-y-4"></div><div class="mt-6 flex justify-end"><button onclick="saveMenuChanges()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold">Simpan Perubahan Menu</button></div></div><div class="card p-4"><h2 class="text-xl font-bold text-white mb-4">Tindakan Berbahaya</h2><button id="reset-data-btn" onclick="resetDailyData()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">Reset Data Hari Ini</button></div></div>
    </template>
    
    <!-- Modals and Templates -->
    <div id="discount-modal-overlay" class="modal-overlay">
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full max-w-sm m-4"><div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-bold text-white">Beri Diskon</h3><button onclick="closeDiscountModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button></div><div class="p-4 space-y-4"><div><label class="text-sm font-bold text-gray-400 block">Tipe Diskon</label><select id="discount-type" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md mt-1"><option value="percent">Persen (%)</option><option value="nominal">Nominal (Rp)</option></select></div><div><label for="discount-value" class="text-sm font-bold text-gray-400 block">Jumlah Diskon</label><input type="number" id="discount-value" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md mt-1"></div></div><div class="p-4 border-t border-gray-700 bg-gray-900/50 flex justify-end gap-3"><button onclick="closeDiscountModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-500 font-semibold">Batal</button><button onclick="applyDiscount()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold">Terapkan</button></div></div>
    </div>
    <div id="menu-modal-overlay" class="modal-overlay">
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-bold text-white">Kelola Menu, Harga & Stok</h3><button onclick="closeMenuModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button></div>
            <div class="p-4 max-h-96 overflow-y-auto"><div id="menu-management-list" class="space-y-4"></div></div>
            <div class="p-4 border-t border-gray-700 bg-gray-900/50 flex justify-end gap-3"><button onclick="closeMenuModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-500 font-semibold">Batal</button><button onclick="saveMenuChanges()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold">Simpan Perubahan</button></div>
        </div>
    </div>
    <div id="receipt-template" class="printable-area">
        <div id="receipt-content" class="text-center"><h3 class="font-bold text-lg">FARISAH FRIED CHICKEN</h3><p>Jl. Contoh Usaha No. 123, Depok</p><p>------------------------------</p><div class="text-left text-xs"><p>No: <span id="receipt-id"></span></p><p>Tgl: <span id="receipt-date"></span></p><p>Kasir: <span id="receipt-cashier"></span></p></div><p>------------------------------</p><table id="receipt-items" class="w-full text-xs"></table><p>------------------------------</p><div id="receipt-summary"></div><p>------------------------------</p><p class="font-semibold mt-2">Terima Kasih!</p><p class="text-xs">klo berani...cobain aja !</p></div>
    </div>
    <div id="shift-report-template" class="printable-area">
        <div id="shift-report-content" style="padding: 20px; border: 1px solid #ccc;"><h1 style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px;">Laporan Serah Terima Shift</h1><table style="width: 100%; margin-bottom: 20px; font-size: 14px;"><tr><td style="font-weight: bold;">Tanggal:</td><td id="report-date-val"></td><td style="font-weight: bold;">Nama Kasir:</td><td id="report-cashier-val"></td></tr></table><hr style="margin-bottom: 20px;"><h2 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Ringkasan Keuangan</h2><table style="width: 50%; font-size: 14px; margin-bottom: 20px;"><tr><td>Pendapatan Kotor:</td><td id="report-gross-val" style="text-align: right;"></td></tr><tr><td>Total Pengeluaran:</td><td id="report-expense-val" style="text-align: right;"></td></tr><tr style="font-weight: bold; border-top: 1px solid #000;"><td>LABA BERSIH:</td><td id="report-net-val" style="text-align: right;"></td></tr></table>
            <hr style="margin-bottom: 20px;"><h2 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Ringkasan Pembayaran</h2>
            <table id="report-payment-summary-table" style="width: 50%; font-size: 14px; margin-bottom: 20px;"></table>
            <hr style="margin-bottom: 20px;"><h2 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Produk Terlaris</h2><div id="report-bestsellers-val"></div><hr style="margin: 20px 0;"><h2 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Rincian Transaksi</h2><table id="report-transactions-table" style="width: 100%; border-collapse: collapse; font-size: 12px;"></table><hr style="margin: 20px 0;"><h2 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Rincian Pengeluaran</h2><table id="report-expenses-table" style="width: 100%; border-collapse: collapse; font-size: 12px;"></table><hr style="margin: 20px 0;"><h2 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Laporan Sisa Stok</h2><table id="report-stock-table" style="width: 100%; border-collapse: collapse; font-size: 12px;"></table></div>
    </div>

    <script>
        // --- GLOBAL STATE & DATA ---
        let currentCart = { items: [], discount: { type: 'nominal', value: 0 } };
        let loggedInUser = null;
        let activeBranch = 'FFC Cabang 1';
        let kdsInterval;

        const users = {
            "siti": { password: "owner123", name: "Siti Fauziah", role: "owner", branch: "All" },
            "aditya": { password: "owner123", name: "Aditya Farhan", role: "owner", branch: "All" },
            "ratih": { password: "karyawan123", name: "Ratih", role: "karyawan", branch: "FFC Cabang 1" },
            "lita": { password: "karyawan123", name: "Lita", role: "karyawan", branch: "FFC Cabang 2" },
            "aura": { password: "karyawan123", name: "Aura", role: "karyawan", branch: "FFC Cabang 3" },
            "rian": { password: "karyawan123", name: "Rian", role: "karyawan", branch: "FFC Cabang 1" },
            "dapur": { password: "dapur123", name: "Dapur", role: "dapur", branch: "All" }
        };
        const branches = ["FFC Cabang 1", "FFC Cabang 2", "FFC Cabang 3"];
        const initialMenuData = {
            "Ayam": [ { name: "Paha Atas", price: 9000}, { name: "Paha Bawah", price: 8000}, { name: "Dada", price: 9000}, { name: "Dada Tulang", price: 9000}, { name: "Sayap", price: 8000} ],
            "Saus": [ { name: "Saus Barbeque", price: 3000}, { name: "Saus Geprek", price: 3000} ],
            "Lainnya": [ { name: "Nasi Putih", price: 5000}, { name: "Kentang Goreng", price: 10000}, { name: "Air Mineral", price: 4000}, { name: "Es Teh Manis", price: 5000} ]
        };
        
        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);
        const getTodayString = () => new Date().toISOString().split('T')[0];
        const getDateString = (daysAgo = 0) => {
            const date = new Date();
            date.setDate(date.getDate() - daysAgo);
            return date.toISOString().split('T')[0];
        }
        const getStorageKey = (key, branch, date) => `ffc_${branch}_${key}_${date}`;

        // --- LOGIN & SESSION & NAVIGATION ---
        window.handleLogin = () => {
            const username = document.getElementById('username').value.toLowerCase().trim();
            const password = document.getElementById('password').value;
            const user = users[username];
            const errorEl = document.getElementById('login-error');

            if (user && user.password === password) {
                loggedInUser = { username: username, ...user };
                sessionStorage.setItem('ffc_loggedInUser', JSON.stringify(loggedInUser));
                errorEl.textContent = '';
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                initApp();
            } else {
                errorEl.textContent = 'Username atau password salah.';
            }
        };

        window.handleLogout = () => {
            loggedInUser = null;
            sessionStorage.removeItem('ffc_loggedInUser');
            if(kdsInterval) clearInterval(kdsInterval);
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        };

        function checkSession() {
            const savedUser = sessionStorage.getItem('ffc_loggedInUser');
            if (savedUser) {
                loggedInUser = JSON.parse(savedUser);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                initApp();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        }

        window.navigateTo = (pageId) => {
            if(kdsInterval) clearInterval(kdsInterval);
            const mainContent = document.getElementById('main-content');
            const template = document.getElementById(`${pageId}-page`);
            if (!template) return;
            mainContent.innerHTML = '';
            mainContent.appendChild(template.content.cloneNode(true));
            
            document.querySelectorAll('#sidebar-nav .sidebar-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === pageId);
            });
            
            if (pageId === 'dashboard') renderDashboard();
            else if (pageId === 'pos') renderPosPage();
            else if (pageId === 'kds') {
                renderKdsPage();
                kdsInterval = setInterval(renderKdsPage, 5000);
            }
            else if (pageId === 'reports') document.getElementById('report-page-date').value = getTodayString();
            else if (pageId === 'settings') renderMenuManagement();
        }

        // --- LOCAL STORAGE FUNCTIONS ---
        function loadDataForBranch(branch, date) {
            const transactions = JSON.parse(localStorage.getItem(getStorageKey('transactions', branch, date)) || '[]');
            const expenses = JSON.parse(localStorage.getItem(getStorageKey('expenses', branch, date)) || '[]');
            let menu = JSON.parse(localStorage.getItem(getStorageKey('menuState', branch, 'all')));
            const counter = parseInt(localStorage.getItem(getStorageKey('transactionCounter', branch, date)) || '0', 10);
            
            if (!menu || Object.keys(menu).length === 0) {
                menu = JSON.parse(JSON.stringify(initialMenuData));
                const stockWithId = {};
                for(const cat in menu) {
                    stockWithId[cat] = menu[cat].map(item => ({...item, stock: 50}));
                }
                menu = stockWithId;
                localStorage.setItem(getStorageKey('menuState', branch, 'all'), JSON.stringify(menu));
            }
            return {transactions, expenses, menu, counter};
        }

        function writeDataForBranch(branch, date, data) {
            localStorage.setItem(getStorageKey('transactions', branch, date), JSON.stringify(data.transactions));
            localStorage.setItem(getStorageKey('expenses', branch, date), JSON.stringify(data.expenses));
            localStorage.setItem(getStorageKey('menuState', branch, 'all'), JSON.stringify(data.menu));
            localStorage.setItem(getStorageKey('transactionCounter', branch, date), data.counter);
        }

        function loadInitialDataForBranch(branch) {
            let menu = JSON.parse(localStorage.getItem(getStorageKey('menuState', branch, 'all')));
            if (!menu || Object.keys(menu).length === 0) {
                menu = JSON.parse(JSON.stringify(initialMenuData));
                const stockWithId = {};
                for(const cat in menu) {
                    stockWithId[cat] = menu[cat].map(item => ({...item, stock: 50}));
                }
                localStorage.setItem(getStorageKey('menuState', branch, 'all'), JSON.stringify(stockWithId));
            }
        }

        // --- RENDER FUNCTIONS ---
        function applyRolePermissions() {
            const navContainer = document.getElementById('sidebar-nav');
            navContainer.innerHTML = '';
            const isOwner = loggedInUser.role === 'owner';

            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>', allowed: ['owner'] },
                { id: 'pos', label: 'Kasir (POS)', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c.51 0 .962-.328 1.099-.832l.345-1.609a2.25 2.25 0 00-2.218-2.553H6.608M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>', allowed: ['owner', 'karyawan'] },
                { id: 'kds', label: 'Tampilan Dapur', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 5.25h7.5M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>', allowed: ['dapur'] },
                { id: 'reports', label: 'Laporan', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>', allowed: ['owner', 'karyawan'] },
                { id: 'settings', label: 'Pengaturan', icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>', allowed: ['owner'] }
            ];

            navItems.forEach(item => {
                if (item.allowed.includes(loggedInUser.role)) {
                    const navItem = document.createElement('div');
                    navItem.className = 'sidebar-item';
                    navItem.dataset.page = item.id;
                    navItem.innerHTML = `${item.icon} ${item.label}`;
                    navItem.onclick = () => navigateTo(item.id);
                    navContainer.appendChild(navItem);
                }
            });
            
            const branchSelectorContainer = document.getElementById('branch-selector-container');
            if(isOwner) {
                branchSelectorContainer.style.display = 'block';
                const selector = document.getElementById('branch-selector');
                selector.innerHTML = '';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch;
                    option.textContent = branch;
                    selector.appendChild(option);
                });
                selector.value = activeBranch;
                selector.onchange = (e) => {
                    activeBranch = e.target.value;
                    navigateTo('dashboard');
                };
            } else {
                branchSelectorContainer.style.display = 'none';
            }
        }

        function renderDashboard() {
            const date = getTodayString();
            document.getElementById('dashboard-branch-name').textContent = `(${activeBranch})`;
            
            const { transactions, expenses } = loadDataForBranch(activeBranch, date);
            calculateFinancialSummary(transactions, expenses);
            
            let salesData = [];
            let maxSales = 0;
            for (let i = 6; i >= 0; i--) {
                const d = getDateString(i);
                const data = loadDataForBranch(activeBranch, d);
                const totalSales = data.transactions.reduce((sum, trx) => sum + trx.total, 0);
                salesData.push({ date: d, totalSales });
                if (totalSales > maxSales) maxSales = totalSales;
            }
            renderSalesChart(salesData);

            const allBranchPerformance = {};
            branches.forEach(b => {
                const data = loadDataForBranch(b, date);
                const revenue = data.transactions.reduce((sum, trx) => sum + trx.total, 0);
                const salesCount = {};
                data.transactions.forEach(trx => { trx.items.forEach(item => { salesCount[item.name] = (salesCount[item.name] || 0) + item.quantity; }); });
                const bestSeller = Object.keys(salesCount).length > 0 ? Object.entries(salesCount).sort((a,b) => b[1] - a[1])[0][0] : '-';
                allBranchPerformance[b] = { revenue, trxCount: data.transactions.length, bestSeller };
            });
            renderBranchPerformanceTable(allBranchPerformance);
        }

        function renderPosPage() {
            const date = document.getElementById('reportDate')?.value || getTodayString();
            const branch = loggedInUser.branch === 'All' ? activeBranch : loggedInUser.branch;
            const data = loadDataForBranch(branch, date);
            
            renderMenu(data.menu);
            renderCart();
            renderBestSellers(data.transactions);
            renderTransactionHistory(data.transactions);
        }

        function renderSalesChart(salesData) {
            const chartContainer = document.getElementById('sales-chart');
            if(!chartContainer) return;
            chartContainer.innerHTML = '';
            let maxSales = Math.max(...salesData.map(d => d.totalSales));
            if(maxSales === 0) maxSales = 1;

            salesData.forEach(data => {
                const barHeight = (data.totalSales / maxSales) * 100;
                const bar = document.createElement('div');
                bar.className = 'flex-1 bg-blue-500 rounded-t-md hover:bg-blue-400 transition-all flex flex-col justify-end items-center group relative';
                bar.style.height = `${barHeight}%`;
                
                const tooltip = document.createElement('div');
                tooltip.className = 'absolute bottom-full mb-2 w-32 bg-gray-900 text-white text-xs rounded py-1 px-2 text-center opacity-0 group-hover:opacity-100 transition-opacity';
                tooltip.innerHTML = `<strong>${new Date(data.date).toLocaleDateString('id-ID', {weekday: 'short', day: 'numeric'})}</strong><br>${formatCurrency(data.totalSales)}`;
                bar.appendChild(tooltip);

                chartContainer.appendChild(bar);
            });
        }
        
        function renderBranchPerformanceTable(performanceData) {
            const container = document.getElementById('branch-performance-table');
            if(!container) return;
            let tableHtml = `<table class="w-full text-left">
                <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                    <tr><th class="p-3">Cabang</th><th class="p-3">Pendapatan</th><th class="p-3">Transaksi</th><th class="p-3">Produk Terlaris</th></tr>
                </thead>
                <tbody class="divide-y divide-gray-700">`;
            
            branches.forEach(branch => {
                const data = performanceData[branch] || { revenue: 0, trxCount: 0, bestSeller: '-' };
                tableHtml += `<tr>
                    <td class="p-3 font-semibold text-white">${branch}</td>
                    <td class="p-3">${formatCurrency(data.revenue)}</td>
                    <td class="p-3">${data.trxCount}</td>
                    <td class="p-3">${data.bestSeller}</td>
                </tr>`;
            });

            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
        }

        function renderMenuManagement() {
            const listContainer = document.getElementById('menu-management-list');
            if (!listContainer) return;
            const branch = loggedInUser.branch === 'All' ? activeBranch : loggedInUser.branch;
            const { menu } = loadDataForBranch(branch, getTodayString());
            
            listContainer.innerHTML = '';
            for (const category in menu) {
                const categoryTitle = document.createElement('h4');
                categoryTitle.className = 'text-md font-bold text-white border-b border-gray-700 pb-1';
                categoryTitle.textContent = category;
                listContainer.appendChild(categoryTitle);
                menu[category].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'grid grid-cols-3 gap-4 items-center';
                    itemDiv.innerHTML = `
                        <label class="font-semibold text-gray-300 col-span-1">${item.name}</label>
                        <div class="col-span-1"><label class="text-sm text-gray-400">Harga:</label><input type="number" data-name="${item.name}" data-category="${category}" data-type="price" value="${item.price}" class="w-full p-1 bg-gray-700 border border-gray-600 rounded-md text-right"></div>
                        <div class="col-span-1"><label class="text-sm text-gray-400">Stok:</label><input type="number" data-name="${item.name}" data-category="${category}" data-type="stock" value="${item.stock}" class="w-full p-1 bg-gray-700 border border-gray-600 rounded-md text-right"></div>
                    `;
                    listContainer.appendChild(itemDiv);
                });
            }
        }
        
        function renderKdsPage() {
            const kdsContainer = document.getElementById('kds-container');
            if(!kdsContainer) return;
            kdsContainer.innerHTML = '';
            
            const allTransactions = [];
            branches.forEach(branch => {
                const data = loadDataForBranch(branch, getTodayString());
                allTransactions.push(...data.transactions);
            });
            
            const activeOrders = allTransactions.filter(trx => trx.status !== 'done');
            activeOrders.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            if (activeOrders.length === 0) {
                kdsContainer.innerHTML = `<p class="text-center py-12 text-gray-500 font-semibold col-span-full">Tidak ada pesanan aktif.</p>`;
                return;
            }

            activeOrders.forEach(trx => {
                const ticket = document.createElement('div');
                const statusClass = trx.status === 'cooking' ? 'cooking' : 'new';
                ticket.className = `kds-ticket p-4 rounded-lg space-y-2 ${statusClass}`;
                
                let itemsHtml = trx.items.map(item => `<li class="flex justify-between"><span class="font-semibold text-xl">${item.quantity}x</span><span class="text-lg">${item.name}</span></li>`).join('');
                
                ticket.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-lg text-white">#${trx.id} - ${trx.branch}</span>
                        <span class="text-xs text-gray-400">${new Date(trx.timestamp).toLocaleTimeString('id-ID')}</span>
                    </div>
                    <ul class="space-y-1">${itemsHtml}</ul>
                    <div class="pt-2 flex gap-2">
                        <button onclick="updateKdsStatus('${trx.id}', '${trx.branch}', 'cooking')" class="w-full py-2 rounded-md bg-yellow-500 text-yellow-900 font-bold text-sm ${trx.status === 'cooking' ? 'opacity-50' : ''}">Proses</button>
                        <button onclick="updateKdsStatus('${trx.id}', '${trx.branch}', 'done')" class="w-full py-2 rounded-md bg-green-500 text-white font-bold text-sm">Selesai</button>
                    </div>
                `;
                kdsContainer.appendChild(ticket);
            });
        }
        
        function calculateFinancialSummary(transactions, expenses) {
            const totalPendapatan = transactions.reduce((sum, trx) => sum + trx.total, 0);
            const totalPengeluaran = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            const labaBersih = totalPendapatan - totalPengeluaran;
            document.querySelectorAll('#finance-pendapatan-kotor').forEach(el => el && (el.textContent = formatCurrency(totalPendapatan)));
            document.querySelectorAll('#finance-total-pengeluaran').forEach(el => el && (el.textContent = `(${formatCurrency(totalPengeluaran)})`));
            document.querySelectorAll('#finance-laba-bersih').forEach(el => {
                if(el) {
                    el.textContent = formatCurrency(labaBersih);
                    el.classList.toggle('text-red-400', labaBersih < 0);
                    el.classList.toggle('text-green-400', labaBersih >= 0);
                }
            });
        }
        
        function renderMenu(menuData) {
            const menuContainer = document.getElementById('menu-container');
            if (!menuContainer) return;
            menuContainer.innerHTML = '';
            for (const category in menuData) {
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `<h3 class="text-lg font-bold text-gray-300 mb-3">${category}</h3>`;
                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid grid-cols-2 lg:grid-cols-2 gap-3';
                menuData[category].forEach(item => {
                    const button = document.createElement('button');
                    button.className = 'menu-button';
                    button.onclick = () => addItemToCart(item.name, item.price);
                    const stock = item.stock;
                    const stockText = stock > 0 ? `Sisa: ${stock}` : 'Habis';
                    button.disabled = stock <= 0;
                    button.innerHTML = `<span>${item.name}</span><span class="block text-sm font-semibold">${stockText}</span>`;
                    gridDiv.appendChild(button);
                });
                categoryDiv.appendChild(gridDiv);
                menuContainer.appendChild(categoryDiv);
            }
        }
        
        function renderTransactionHistory(transactionsData) {
            const historyContainer = document.getElementById('transaction-history');
            if (!historyContainer) return;
            historyContainer.innerHTML = '';
            if (transactionsData.length === 0) {
                 historyContainer.innerHTML = `<p class="text-center py-8 text-gray-500 font-semibold">Belum ada transaksi</p>`;
                 return;
            }
            transactionsData.slice().reverse().forEach(trx => {
                const trxDiv = document.createElement('div');
                trxDiv.className = 'bg-gray-800 p-2 rounded-md border border-gray-700 text-sm flex justify-between items-center';
                const timestamp = new Date(trx.timestamp);
                trxDiv.innerHTML = `
                    <div><span class="font-semibold text-white">Transaksi #${trx.id}</span><span class="block text-xs text-gray-400">${timestamp.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })} - Kasir: <strong>${trx.cashier || 'N/A'}</strong></span></div>
                    <div class="text-right"><span class="font-bold text-green-400">${formatCurrency(trx.total)}</span><button onclick="generateReceipt('${trx.id}')" class="block text-xs bg-blue-600 text-white px-2 py-0.5 rounded-full mt-1 hover:bg-blue-500">Cetak Struk</button></div>
                `;
                historyContainer.appendChild(trxDiv);
            });
        }
        
        function renderBestSellers(transactionsData) {
            const container = document.getElementById('best-sellers-container');
            if (!container) return;
            container.innerHTML = '';
            const salesCount = {};
            transactionsData.forEach(trx => {
                trx.items.forEach(item => {
                    salesCount[item.name] = (salesCount[item.name] || 0) + item.quantity;
                });
            });

            const sortedItems = Object.entries(salesCount).sort((a, b) => b[1] - a[1]).slice(0, 3);

            if (sortedItems.length === 0) {
                container.innerHTML = `<p class="text-center py-4 text-gray-500 font-semibold">Belum ada data penjualan</p>`;
                return;
            }

            sortedItems.forEach(([name, count], index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center gap-3';
                const medalColors = ['text-yellow-400', 'text-gray-400', 'text-yellow-600'];
                itemDiv.innerHTML = `
                    <div class="font-bold text-lg ${medalColors[index] || 'text-gray-500'}">${index + 1}.</div>
                    <div class="flex-grow font-semibold text-gray-300">${name}</div>
                    <div class="font-bold text-white">${count} terjual</div>
                `;
                container.appendChild(itemDiv);
            });
        }
        
        function renderCart() {
            const tableBody = document.getElementById('cart-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (currentCart.items.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-12 text-gray-400 font-semibold">Pilih menu di sebelah kiri</td></tr>`;
            } else {
                currentCart.items.forEach(item => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td class="p-2 font-semibold text-gray-300">${item.name}</td>
                        <td class="p-2"><div class="flex items-center justify-center gap-2"><button onclick="updateQuantity('${item.name}', -1)" class="qty-button">-</button><span class="font-bold w-6 text-center">${item.quantity}</span><button onclick="updateQuantity('${item.name}', 1)" class="qty-button">+</button></div></td>
                        <td class="p-2 text-right font-bold text-white">${formatCurrency(item.price * item.quantity)}</td>
                    `;
                });
            }
            
            const subtotal = currentCart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discountAmount = 0;
            if (currentCart.discount.type === 'percent') {
                discountAmount = subtotal * (currentCart.discount.value / 100);
            } else {
                discountAmount = currentCart.discount.value;
            }
            const total = subtotal - discountAmount;

            document.getElementById('cart-subtotal').textContent = formatCurrency(subtotal);
            const discountDisplay = document.getElementById('discount-display');
            if (discountAmount > 0) {
                document.getElementById('cart-discount-amount').textContent = `- ${formatCurrency(discountAmount)}`;
                discountDisplay.classList.remove('hidden');
            } else {
                discountDisplay.classList.add('hidden');
            }
            document.getElementById('cart-total').textContent = formatCurrency(total);
        }
        
        // --- DATA HANDLING LOGIC (OFFLINE) ---
        function saveTransaction() {
            if (currentCart.items.length === 0) return;
            const branch = loggedInUser.branch === 'All' ? activeBranch : loggedInUser.branch;
            const date = getTodayString();
            const data = loadDataForBranch(branch, date);
            
            currentCart.items.forEach(cartItem => {
                for (const category in data.menu) {
                    const itemInMenu = data.menu[category].find(item => item.name === cartItem.name);
                    if (itemInMenu) {
                        itemInMenu.stock -= cartItem.quantity;
                        break;
                    }
                }
            });

            data.counter++;
            const newTransaction = {
                id: data.counter,
                items: currentCart.items,
                discount: currentCart.discount,
                total: parseFloat(document.getElementById('cart-total').textContent.replace(/[^0-9,-]+/g,"")),
                timestamp: new Date().toISOString(),
                cashier: loggedInUser.name,
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                branch: branch,
                status: 'new'
            };
            data.transactions.push(newTransaction);
            writeDataForBranch(branch, date, data);
            currentCart = { items: [], discount: { type: 'nominal', value: 0 } };
            renderPosPage();
        }
        
        function addExpenseRow() {
            const branch = loggedInUser.branch === 'All' ? activeBranch : loggedInUser.branch;
            const date = getTodayString();
            const data = loadDataForBranch(branch, date);
            const newExpense = { id: `exp_${Date.now()}`, name: 'Biaya Baru', amount: 0 };
            data.expenses.push(newExpense);
            writeDataForBranch(branch, date, data);
            renderPosPage();
        }

        function updateExpense(docId, field, value) {
            const branch = loggedInUser.branch === 'All' ? activeBranch : loggedInUser.branch;
            const date = getTodayString();
            const data = loadDataForBranch(branch, date);
            const expense = data.expenses.find(e => e.id === docId);
            if (expense) {
                expense[field] = (field === 'amount') ? parseFloat(value) || 0 : value;
                writeDataForBranch(branch, date, data);
                calculateFinancialSummary(data.transactions, data.expenses);
            }
        }

        function removeExpense(docId) {
            const branch = loggedInUser.branch === 'All' ? activeBranch : loggedInUser.branch;
            const date = getTodayString();
            const data = loadDataForBranch(branch, date);
            data.expenses = data.expenses.filter(e => e.id !== docId);
            writeDataForBranch(branch, date, data);
            renderPosPage();
        }

        // --- CART & STOCK LOGIC (Local) ---
        function findMenuItem(name) {
            const branch = loggedInUser.branch === 'All' ? activeBranch : loggedInUser.branch;
            const { menu } = loadDataForBranch(branch, getTodayString());
            for (const category in menu) {
                const item = menu[category].find(i => i.name === name);
                if (item) return item;
            }
            return null;
        }

        window.addItemToCart = (name, price) => {
            const menuItem = findMenuItem(name);
            const itemInCart = currentCart.items.find(item => item.name === name);
            const currentQtyInCart = itemInCart ? itemInCart.quantity : 0;
            
            if (menuItem.stock - currentQtyInCart <= 0) {
                alert(`Stok ${name} tidak mencukupi.`);
                return;
            }

            if (itemInCart) {
                itemInCart.quantity++;
            } else {
                currentCart.items.push({ name, price, quantity: 1 });
            }
            renderCart();
        }

        window.updateQuantity = (name, change) => {
            const itemIndex = currentCart.items.findIndex(item => item.name === name);
            if (itemIndex === -1) return;
            
            let newQty = currentCart.items[itemIndex].quantity + change;
            
            const menuItem = findMenuItem(name);
            if (change > 0 && newQty > menuItem.stock) {
                alert(`Stok ${name} tidak mencukupi.`);
                newQty = menuItem.stock;
            }

            if (newQty <= 0) {
                currentCart.items.splice(itemIndex, 1);
            } else {
                currentCart.items[itemIndex].quantity = newQty;
            }
            renderCart();
        }

        // --- MODAL & PDF & RESET & KDS ---
        window.openMenuModal = () => {
            renderMenuManagement();
            document.getElementById('menu-modal-overlay').style.display = 'flex';
        }

        window.closeMenuModal = () => {
            document.getElementById('menu-modal-overlay').style.display = 'none';
        }

        window.saveMenuChanges = () => {
            const branch = loggedInUser.branch === 'All' ? activeBranch : loggedInUser.branch;
            const data = loadDataForBranch(branch, getTodayString());
            
            const inputs = document.querySelectorAll('#menu-management-list input');
            inputs.forEach(input => {
                const itemName = input.dataset.name;
                const category = input.dataset.category;
                const inputType = input.dataset.type;
                const newValue = parseInt(input.value, 10);
                
                const itemIndex = data.menu[category].findIndex(i => i.name === itemName);
                if (itemIndex > -1) {
                    data.menu[category][itemIndex][inputType] = isNaN(newValue) ? 0 : newValue;
                }
            });
            writeDataForBranch(branch, getTodayString(), data);
            renderMenu();
            closeMenuModal();
        }

        window.openDiscountModal = () => {
            document.getElementById('discount-modal-overlay').style.display = 'flex';
        }
        window.closeDiscountModal = () => {
            document.getElementById('discount-modal-overlay').style.display = 'none';
        }
        window.applyDiscount = () => {
            const type = document.getElementById('discount-type').value;
            const value = parseFloat(document.getElementById('discount-value').value) || 0;
            currentCart.discount = { type, value };
            renderCart();
            closeDiscountModal();
        }

        window.resetDailyData = () => {
            const date = document.getElementById('report-page-date')?.value || getTodayString();
            const branch = loggedInUser.branch === 'All' ? activeBranch : loggedInUser.branch;
            if (confirm(`Anda yakin ingin menghapus semua data untuk tanggal ${date} di cabang ${branch}? Aksi ini tidak bisa dibatalkan.`)) {
                localStorage.removeItem(getStorageKey('transactions', branch, date));
                localStorage.removeItem(getStorageKey('expenses', branch, date));
                localStorage.removeItem(getStorageKey('transactionCounter', branch, date));
                navigateTo('dashboard');
            }
        }
        
        window.updateKdsStatus = (trxId, branch, newStatus) => {
            const date = getTodayString();
            const data = loadDataForBranch(branch, date);
            const trxIndex = data.transactions.findIndex(t => t.id == trxId);
            if (trxIndex > -1) {
                data.transactions[trxIndex].status = newStatus;
                writeDataForBranch(branch, date, data);
                renderKdsPage();
            }
        };

        window.generateReceipt = (transactionId) => {
            const date = getTodayString();
            const branch = loggedInUser.branch === 'All' ? activeBranch : loggedInUser.branch;
            const { transactions } = loadDataForBranch(branch, date);
            const trx = transactions.find(t => t.id == transactionId);
            if (!trx) return;
            // ... (rest of PDF generation logic)
        }
        
        window.generateShiftReport = () => {
            // ... (rest of PDF generation logic)
        }

        window.exportToCSV = () => {
            // ... (rest of CSV generation logic)
        }

        // --- INITIALIZATION ---
        function initApp() {
            document.getElementById('user-name-display').textContent = loggedInUser.name;
            document.getElementById('user-role-display').textContent = loggedInUser.role.charAt(0).toUpperCase() + loggedInUser.role.slice(1);
            
            if (loggedInUser.branch !== 'All') {
                activeBranch = loggedInUser.branch;
            } else {
                activeBranch = 'FFC Cabang 1'; // Default for owner
            }

            branches.forEach(b => loadInitialDataForBranch(b));
            
            applyRolePermissions();
            const defaultPage = loggedInUser.role === 'owner' ? 'dashboard' : (loggedInUser.role === 'dapur' ? 'kds' : 'pos');
            navigateTo(defaultPage);
        }

        window.onload = () => {
            checkSession();
        };
    </script>
</body>
</html>
